# Install Mariadb10.x
sudo dnf install -y mariadb105-server
sudo systemctl start mariadb
sudo systemctl enable mariadb
sudo systemctl status mariadb


# Edit Parameter File
sudo vi /etc/my.cnf.d/mariadb-server.cnf
server-id = 2  
expire_logs_days=2
binlog_format = ROW 
max_binlog_size = 1G 
log-bin =mariadb-bin
binlog_row_image=FULL
binlog_checksum=NONE
log_slave_updates=TRUE
log-bin-index =mariadb-bin.index
# gtid_mode = ON
# enforce_gtid_consistency = ON
# bind-address = 0.0.0.0

sudo systemctl stop mariadb
sudo systemctl start mariadb

sudo su
mysql
# Create Admin and Replication Users
CREATE USER 'admin_user'@'%' IDENTIFIED BY 'admin_password';
GRANT ALL PRIVILEGES ON *.* TO 'admin_user'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;


# Install Perl modules required by pt-online-schema-change
sudo yum install -y perl-English perl-Time-HiRes perl-Digest-MD5 perl-FindBin perl-sigtrap perl-DBD-MySQL

wget https://www.percona.com/downloads/percona-toolkit/3.5.7/binary/tarball/percona-toolkit-3.5.7_x86_64.tar.gz
tar -xzvf percona-toolkit-3.5.7_x86_64.tar.gz
export PATH=$PATH:~/percona-toolkit-3.5.7/bin:.

sudo dnf install -y git
wget https://github.com/datacharmer/test_db.git
unzip test_db-master.zip
cd test_db-master/
sudo su
mysql -t < employees.sql

wget https://downloads.mysql.com/docs/sakila-db.zip
unzip sakila-db.zip
cd sakila-db/
sudo su 
mysql -t < sakila-schema.sql
mysql -t < sakila-data.sql

SELECT tc.constraint_schema,tc.constraint_name,tc.table_name,tc.constraint_type,kcu.table_name,kcu.column_name,kcu.referenced_table_name,kcu.referenced_column_name,rc.update_rule,rc.delete_rule
FROM information_schema.table_constraints tc
inner JOIN information_schema.key_column_usage kcu
ON tc.constraint_catalog = kcu.constraint_catalog
AND tc.constraint_schema = kcu.constraint_schema
AND tc.constraint_name = kcu.constraint_name
AND tc.table_name = kcu.table_name
LEFT JOIN information_schema.referential_constraints rc
ON tc.constraint_catalog = rc.constraint_catalog
AND tc.constraint_schema = rc.constraint_schema
AND tc.constraint_name = rc.constraint_name
AND tc.table_name = rc.table_name
WHERE tc.constraint_schema = 'sample' ;

CREATE TABLE customer (
  id INT NOT NULL AUTO_INCREMENT,
  firstname varchar(50) NOT NULL,
  lastname varchar(50) NOT NULL,
  PRIMARY KEY (id)
) ENGINE=INNODB;

CREATE TABLE contact (
  id INT,
  customer_id INT,
  info varchar(50) NOT NULL,
  type varchar(50) NOT NULL,
) ENGINE=INNODB;

INSERT INTO customer (firstname, lastname) VALUES
('Elaine', 'Stevens'),
('Mary', 'Dittman'),
('Skip', 'Stevenson');

export DB_HOST=35.163.206.156
export DB_USERNAME=admin_user
export DB_PASSWORD=admin_password
pt-online-schema-change h=$DB_HOST,u=$DB_USERNAME,p=$DB_PASSWORD,D=employees,t=employees --critical-load Threads_running=100 --max-load Threads_running=15 --alter "MODIFY emp_no bigint (20) unsigned" --tries swap_tables:50:5 --set-vars wait_timeout=43200,lock_wait_timeout=1800 --execute
pt-online-schema-change h=$DB_HOST,u=$DB_USERNAME,p=$DB_PASSWORD,D=employees,t=employees --critical-load Threads_running=100 --max-load Threads_running=15 --alter "MODIFY emp_no bigint (20) unsigned" --tries swap_tables:50:5 --set-vars wait_timeout=43200,lock_wait_timeout=1800 --execute --alter-foreign-keys-method=auto
pt-online-schema-change h=$DB_HOST,u=$DB_USERNAME,p=$DB_PASSWORD,D=employees,t=employees --critical-load Threads_running=100 --max-load Threads_running=15 --alter "ADD COLUMN uuid_col CHAR(36) AFTER emp_no, DROP PRIMARY KEY, ADD PRIMARY KEY (uuid_col), MODIFY uuid_col CHAR(36) NOT NULL" --tries swap_tables:50:5 --set-vars wait_timeout=43200,lock_wait_timeout=1800 --execute --alter-foreign-keys-method=auto

pt-online-schema-change h=$DB_HOST,u=$DB_USERNAME,p=$DB_PASSWORD,D=sakila,t=actor --critical-load Threads_running=100 --max-load Threads_running=15 --alter "ADD COLUMN UUID BINARY(16) NOT NULL DEFAULT UUID(), DROP PRIMARY KEY, ADD PRIMARY KEY (UUID)" --tries swap_tables:50:5 --set-vars wait_timeout=43200,lock_wait_timeout=1800 --execute --alter-foreign-keys-method=auto --no-check-unique-key-change --no-check-alte

pt-online-schema-change h=$DB_HOST,u=$DB_USERNAME,p=$DB_PASSWORD,D=sakila,t=actor --critical-load Threads_running=100 --max-load Threads_running=15 --alter "MODIFY actor_id bigint (20) unsigned" --tries swap_tables:50:5 --set-vars wait_timeout=43200,lock_wait_timeout=1800 --execute  --alter-foreign-keys-method=auto

time pt-online-schema-change \
h=$DB_HOST,\
u=$DB_USERNAME,\
p=$DB_PASSWORD,\
D=sakila,t=actor \
--max-lag=100 \
--critical-load Threads_running=100 \
--max-load Threads_running=15 \
--nocheck-replication-filters \
--alter "MODIFY actor_id bigint (20) unsigned" \
--tries swap_tables:50:5 \
--set-vars wait_timeout=43200,lock_wait_timeout=1800 \
--alter-foreign-keys-method=drop_swap \
--execute
pt-online-schema-change --alter "engine='InnoDB'" h=$DB_HOST,D=sakila,t=actor --ask-pass --progress time,10 --print --nocheck-replication-filters 
--recursion-method=none --set-vars="SQL_LOG_BIN=OFF" --max-load "Threads_connected=900" --alter-foreign-keys-method=drop_swap --execute



time pt-online-schema-change h=$DB_HOST,u=$DB_USERNAME,p=$DB_PASSWORD,D=sakila,t=actor --max-lag=100 --critical-load Threads_running=100 --max-load Threads_running=15 --nocheck-replication-filters --alter "MODIFY actor_id bigint (20) unsigned" --tries swap_tables:50:5 --set-vars wait_timeout=43200,lock_wait_timeout=1800 --alter-foreign-keys-method=rebuild_constraints --plugin=/home/ec2-user/sakila-db/ptosc_plugin_drop_fk.pl
